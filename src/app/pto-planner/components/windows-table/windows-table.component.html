<h2>Accrual Windows (this year)</h2>
<table id="windowsTable">
  <thead>
  <tr>
    <th>Window</th>
    <th>Accrual date</th>
    <th>Start balance</th>
    <th>Entries in window</th>
    <th>PTO used</th>
    <th>Accrual posted (override)</th>
    <th>End balance</th>
  </tr>
  </thead>
  <tbody>
  <ng-container *ngFor="let w of store.windows(); let wi = index; trackBy: trackByWindow">
    <tr>
      <td class="nw">{{ formatDateDisplay(w.start) }} → {{ formatDateDisplay(w.endDisplay) }}</td>
      <td class="nw">{{ formatDateDisplay(w.accrualDate) }}</td>
      <td>{{ store.fmt(w.startBal) }} h</td>
      <td>
        <div class="win-chiplist" *ngIf="w.items.length; else none">
            <span class="win-chip" *ngFor="let it of w.items; trackBy: trackByEntry">
              {{ formatDateDisplay(it.date) }}: -{{ store.fmt(it.hours) }} h<span *ngIf="it.note"> — {{ it.note }}</span>
            </span>
        </div>
        <ng-template #none><span class="win-chiplist">—</span></ng-template>
      </td>
      <td>-{{ store.fmt(w.used) }} h</td>
      <td>
        <input class="accrual-input" type="number" step="0.01" #accrualInput
               [attr.data-window-key]="w.key"
               [value]="store.getOverride(w.key, w.computed)"
               (focus)="onAccrualFocus(w.key, accrualInput)"
               (blur)="onAccrualBlur(w.key, accrualInput)" />
        <div class="hint">(computed: +{{ store.fmt(w.computed) }} h)</div>
      </td>
      <td [class.ok]="w.endBal>=0" [class.bad]="w.endBal<0">{{ store.fmt(w.endBal) }} h
        <div class="win-actions" style="margin-top:6px">
          <button class="win-manage" type="button" (click)="toggleManage(wi)">Manage</button>
        </div>
      </td>
    </tr>

    <tr class="win-editor" [style.display]="openEditor===wi ? 'table-row' : 'none'">
      <td [attr.colspan]="7">
        <div class="hint" style="margin-bottom:6px">
          Date must be inside the window (inclusive start, exclusive end).
        </div>
        <div class="editor-body">
          <!-- Editor rows -->
          <div class="row" *ngFor="let it of w.items; let ri = index; trackBy: trackByEntry">
            <input type="date"
                   [(ngModel)]="it.date"
                   [attr.min]="w.start"
                   [attr.max]="w.endDisplay"
                   (change)="commitEditorRow(wi, ri)" />
            <input type="number" step="0.01"
                   [(ngModel)]="it.hours"
                   (change)="commitEditorRow(wi, ri)" />
            <input type="text"
                   [(ngModel)]="it.note"
                   (change)="commitEditorRow(wi, ri)" />
            <div>
              <button class="mini" (click)="commitEditorRow(wi, ri)">Save</button>
              <button class="mini del" (click)="deleteEditorRow(wi, ri)">Delete</button>
            </div>
          </div>

          <!-- Add block: per-window drafts -->
          <div class="add-block">
            <div class="row">
              <input type="date"
                     [ngModel]="getAddDate(wi, w.start)"
                     (ngModelChange)="newDateByWin[wi]=$event"
                     [attr.min]="w.start"
                     [attr.max]="w.endDisplay" />
              <input type="number" class="new-hours" step="0.01"
                     [ngModel]="getAddHours(wi)"
                     (ngModelChange)="newHoursByWin[wi]=+($event||0)" />
              <input type="text" class="new-note" placeholder="Note (optional)"
                     [ngModel]="getAddNote(wi)"
                     (ngModelChange)="newNoteByWin[wi]=$event||''" />
              <button class="mini add" type="button" (click)="addEditorRow(wi)">Add</button>
            </div>
          </div>
        </div>
      </td>
    </tr>
  </ng-container>
  </tbody>
</table>

<!-- Confirmation Modal -->
<div class="modal-overlay" *ngIf="showConfirmModal" (click)="cancelAccrualChange()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <h3>Confirm Accrual Change</h3>
    <p>Are you sure you want to change the Accrual value?</p>
    <div class="modal-actions">
      <button class="modal-btn cancel" (click)="cancelAccrualChange()">Cancel</button>
      <button class="modal-btn confirm" (click)="confirmAccrualChange()">Yes</button>
    </div>
  </div>
</div>

